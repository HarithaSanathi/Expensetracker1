<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>NoVAHAMOTECH - complete tracker app</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f7fafc; color: #222; min-height: 100vh; display: flex; flex-direction: column; }
    .app-container { display: flex; min-height: 100vh;}
    aside {
      background: #014378; color: white; width: 230px; min-height: 100vh;
      padding: 40px 0 0 0; box-shadow: 2px 0 12px rgba(0,0,0,0.07);
      position: sticky; top: 0; display: flex; flex-direction: column;
    }
    aside .logo {
      margin-bottom: 40px; font-size: 27px; font-weight: bold;
      text-align: center; letter-spacing: 2px;
      font-family: 'Courier New', Courier, monospace;
    }
    aside nav ul {
      padding: 0; margin: 0;
      display: flex; flex-direction: column; gap: 22px;
      list-style: none;
    }
    aside nav ul li {
      margin: 0; width: 100%;
    }
    aside nav ul li a {
      color: white; text-decoration: none; font-size: 1.09em;
      padding: 10px 35px; border-radius: 0 25px 25px 0; display: block;
      transition: background 0.21s;
    }
    aside nav ul li a.active,
    aside nav ul li a:hover {
      background: #1976d2;
    }
    main {
      padding: 38px 28px; flex: 1; max-width: 100vw; min-height: 100vh; background: #f7fafc;
    }
    .slide { margin-bottom: 32px;}
    .slide h1 { font-size:2.1em; color:#014378;}
    .slide h3 { color:#0955a9;}
    .slide p { color:#434343; font-size:1.10em;}
    .tracker-section {
      display: none; background: white;
      border-radius: 12px; padding: 30px;
      box-shadow: 0 1px 5px rgba(0,67,120,0.07);
      margin-bottom: 18px; max-width: 700px;
    }
    .tracker-section.active { display: block;}
    .tracker-section h2 { color: #1976d2;}
    form { display: flex; gap:10px; flex-wrap:wrap; margin-bottom:16px; }
    form input:not([type="date"]), form select { width: 120px; }
    form input, form select, form button {
      padding: 7px 5px; border-radius: 3px;
      border: 1px solid #eee;
      font-size: 1em;
    }
    form button {
      background: #1976d2;
      color: white;
      border: none;
      width: 82px;
      cursor: pointer;
      margin-bottom: 7px;
    }
    form button:hover { background: #014378; }
    table { width: 100%; border-collapse: collapse; margin-bottom:12px;}
    th, td {
      padding: 7px 6px;
      border-bottom: 1px solid #ececec;
      text-align: left;
    }
    th { background: #f2f6fa;}
    .delete-btn, .edit-btn, .save-btn, .cancel-btn {
      color: white;
      border-radius: 4px;
      border: none;
      padding: 4px 9px;
      margin: 1px; font-size: 0.99em;
      cursor: pointer;
      transition: background .22s;
    }
    .delete-btn { background: #e53935; }
    .delete-btn:hover { background: #c62828;}
    .edit-btn { background: #ffb300; color:#222;}
    .edit-btn:hover { background: #ffa000;}
    .save-btn { background: #1976d2;}
    .save-btn:hover { background:#014378;}
    .cancel-btn { background: #888;}
    .cancel-btn:hover { background: #666;}
    .totals { text-align:right; margin-top:6px;}
    .dashboard-summary { background:#e8f0fe; max-width:840px; margin-bottom:30px; border-radius:14px; box-shadow:0 2px 7px rgba(25,118,210,0.06); padding:28px 24px; display:flex; justify-content:space-between; align-items:center;}
    .dashboard-summary h2 { color:#014378; margin-top:0;}
    .dashboard-row {display:flex;gap:36px;flex-wrap:wrap;}
    .dashboard-cell {flex:1; min-width:140px; text-align: center; margin-bottom: 10px;}
    .dashboard-total {flex:1; background:#1976d210; border-radius:12px; padding:8px 14px; text-align: center;}
    .dashboard-balance {font-size:1.4em; color:#1976d2; font-weight:bold;}
    .status-pending { background: #fffde7; color: #e65100; font-weight:bold; border-radius:5px; padding:2px 6px;}
    .status-completed { background: #e6ffed; color: #388e3c; font-weight:bold; border-radius:5px; padding:2px 6px;}
    .chart-area {margin:16px 0 30px 0; max-width:390px; height:180px;}
    .api-status { font-size:0.85em; padding:6px 10px; border-radius:8px; background:#e6f4ea; color:#166534; border:1px solid #c7eed0; }
    .api-status.offline { background:#fff1f0; color:#9a1c1c; border:1px solid #ffd6d6;}
    .toast { position: fixed; right: 18px; bottom: 18px; background: rgba(0,0,0,0.85); color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.18); display:none; z-index:9999;}
    @media (max-width: 850px) {
      .app-container { flex-direction: column; }
      aside { width:100vw; flex-direction: row; min-height:unset; padding: 12px 0;}
      aside .logo { padding:0; margin:0 0 0 22px; text-align:left;}
      aside nav ul { flex-direction: row;gap:8px;flex:1;}
      aside nav ul li a {
        padding:10px 13px;width:auto; font-size:1em;
        border-radius:10px;
      }
      main { padding:24px 6vw;}
      .dashboard-summary { padding:18px 6vw; flex-direction:column; gap:12px; align-items:flex-start;}
    }
    @media (max-width: 560px) {
      main { padding: 10px;}
      .tracker-section, .slide, .dashboard-summary { padding: 12px;}
      .dashboard-row { flex-direction:column; gap:16px;}
      .chart-area {max-width:97vw;}
      .tracker-section { max-width:100vw; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <aside>
      <div class="logo">NoVAHAMOTECH</div>
      <nav>
        <ul>
          <li><a href="#dashboard" class="active">Dashboard</a></li>
          <li><a href="#salary">Salary Tracker</a></li>
          <li><a href="#house">House Expenses</a></li>
          <li><a href="#office">Office Expenses</a></li>
        </ul>
      </nav>
    </aside>
    <main>
      <section id="dashboard-slide" class="slide">
        <h1>Welcome to NoVAHAMOTECH!</h1>
        <p>Track all your finances—salary, house expenses, office expenses—all in one secure online dashboard. NoVAHAMOTECH helps you manage every credit and debit with clarity. Works seamlessly across desktop and mobile devices.</p>
      </section>

      <section id="global-dashboard" class="dashboard-summary" style="display:block;">
        <div>
          <h2>Total Account Dashboard</h2>
          <div class="dashboard-row">
            <div class="dashboard-cell">
              <h3>Total Balance</h3>
              <div class="dashboard-balance">₹<span id="dash-salary">0.00</span></div>
            </div>
            <div class="dashboard-cell">
              <h3>House Balance</h3>
              <div class="dashboard-balance">₹<span id="dash-house">0.00</span></div>
            </div>
            <div class="dashboard-cell">
              <h3>Office Balance</h3>
              <div class="dashboard-balance">₹<span id="dash-office">0.00</span></div>
            </div>
            <div class="dashboard-total">
              <h3>Total Balance</h3>
              <div class="dashboard-balance" style="font-size:1.7em;">₹<span id="dash-total">0.00</span></div>
            </div>
          </div>
        </div>
        <div>
          <div id="apiStatus" class="api-status">Checking API...</div>
          <div style="height:8px"></div>
        </div>
      </section>

      <section id="salary-section" class="tracker-section">
        <h2>TotalExpenses</h2>
        <form id="salary-form" autocomplete="off">
          <input type="text" id="salary-desc" placeholder="Description" required />
          <input type="number" id="salary-amt" placeholder="Amount" min="0" step="0.01" required />
          <select id="salary-type" required>
            <option value="" disabled selected>Type</option>
            <option value="Credit">Credit</option>
            <option value="Debit">Debit</option>
          </select>
          <input type="date" id="salary-date" required />
          <select id="salary-status" required>
            <option value="Pending">Pending</option>
            <option value="Completed">Completed</option>
          </select>
          <button type="submit">Add</button>
        </form>
        <div class="chart-area"><canvas id="salaryChart"></canvas></div>
        <table>
          <thead>
            <tr>
              <th>Description</th>
              <th>Amount (₹)</th>
              <th>Type</th>
              <th>Date</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="salary-list"></tbody>
        </table>
        <div class="totals">Total: ₹<span id="salary-total">0.00</span></div>
      </section>

      <section id="house-section" class="tracker-section">
        <h2>House Expense Tracker</h2>
        <form id="house-form" autocomplete="off">
          <input type="text" id="house-desc" placeholder="Description" required />
          <input type="number" id="house-amt" placeholder="Amount" min="0" step="0.01" required />
          <select id="house-type" required>
            <option value="" disabled selected>Type</option>
            <option value="Credit">Credit</option>
            <option value="Debit">Debit</option>
          </select>
          <input type="date" id="house-date" required />
          <select id="house-status" required>
            <option value="Pending">Pending</option>
            <option value="Completed">Completed</option>
          </select>
          <button type="submit">Add</button>
        </form>
        <div class="chart-area"><canvas id="houseChart"></canvas></div>
        <table>
          <thead>
            <tr>
              <th>Description</th>
              <th>Amount (₹)</th>
              <th>Type</th>
              <th>Date</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="house-list"></tbody>
        </table>
        <div class="totals">Total: ₹<span id="house-total">0.00</span></div>
      </section>

      <section id="office-section" class="tracker-section">
        <h2>Office Expense Tracker</h2>
        <form id="office-form" autocomplete="off">
          <input type="text" id="office-desc" placeholder="Description" required />
          <input type="number" id="office-amt" placeholder="Amount" min="0" step="0.01" required />
          <select id="office-type" required>
            <option value="" disabled selected>Type</option>
            <option value="Credit">Credit</option>
            <option value="Debit">Debit</option>
          </select>
          <input type="date" id="office-date" required />
          <select id="office-status" required>
            <option value="Pending">Pending</option>
            <option value="Completed">Completed</option>
          </select>
          <button type="submit">Add</button>
        </form>
        <div class="chart-area"><canvas id="officeChart"></canvas></div>
        <table>
          <thead>
            <tr>
              <th>Description</th>
              <th>Amount (₹)</th>
              <th>Type</th>
              <th>Date</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="office-list"></tbody>
        </table>
        <div class="totals">Total: ₹<span id="office-total">0.00</span></div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ---------- Configuration ----------
    // Set your backend API base here. If it is down or CORS prevents access, the app falls back to localStorage.
    const apiBase = 'https://expensetracker-inlr.onrender.com/api'; // keep or change

    // ---------- Utility: toast ----------
    function showToast(msg, ms = 3000) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(t._timeout);
      t._timeout = setTimeout(() => t.style.display = 'none', ms);
    }

    // ---------- API status check ----------
    async function checkApiStatus() {
      const el = document.getElementById('apiStatus');
      try {
        // Try a lightweight GET to the /health or root collection if not available then fallback to a generic fetch
        const testUrl = `${apiBase.replace(/\/$/, '')}/ping` ; // backend can implement /ping or /health
        const res = await fetch(testUrl, { method: 'GET', cache: 'no-cache' });
        if (res.ok) {
          el.classList.remove('offline');
          el.textContent = 'API: Online';
          return true;
        } else {
          // not ok, but API reachable
          el.classList.add('offline');
          el.textContent = 'API: Unhealthy';
          return false;
        }
      } catch (err) {
        el.classList.add('offline');
        el.textContent = 'API: Offline (using local data)';
        return false;
      }
    }

    // ---------- Local storage helpers ----------
    function storageKey(prefix) { return `expensetracker:${prefix}`; }
    function loadLocal(prefix) {
      try {
        const raw = localStorage.getItem(storageKey(prefix));
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('local load error', e);
        return [];
      }
    }
    function saveLocal(prefix, entries) {
      try {
        localStorage.setItem(storageKey(prefix), JSON.stringify(entries));
      } catch (e) {
        console.error('local save error', e);
      }
    }

    // ---------- Core tracker creator ----------
    function createTracker(prefix, dashId, chartId) {
      const form = document.getElementById(`${prefix}-form`);
      const list = document.getElementById(`${prefix}-list`);
      const totalBox = document.getElementById(`${prefix}-total`);
      let entries = [];
      let editingIndex = null;
      let online = false;

      const chartCtx = document.getElementById(chartId).getContext('2d');
      let chart;

      async function fetchEntries() {
        // Try API first. If failed, fallback to localStorage.
        try {
          const res = await fetch(`${apiBase}/${prefix}`);
          if (!res.ok) throw new Error('API not ok');
          const data = await res.json();
          // ensure ids exist
          entries = data.map(e => ({ ...e, id: e.id ?? e._id ?? String(Date.now() + Math.random()) }));
          saveLocal(prefix, entries); // sync local copy
          online = true;
        } catch (err) {
          console.warn(`${prefix}: API fetch failed, loading local`, err);
          entries = loadLocal(prefix);
          online = false;
          showToast(`${prefix} — using local data`);
        } finally {
          render();
        }
      }

      async function saveEntry(entry, idx) {
        // If online, attempt API POST/PUT. If API fails, fall back to local.
        if (online) {
          try {
            let res;
            if (idx === null) {
              res = await fetch(`${apiBase}/${prefix}`, {
                method: 'POST',
                body: JSON.stringify(entry),
                headers: { 'Content-Type': 'application/json' }
              });
            } else {
              res = await fetch(`${apiBase}/${prefix}/${entry.id}`, {
                method: 'PUT',
                body: JSON.stringify(entry),
                headers: { 'Content-Type': 'application/json' }
              });
            }
            if (!res.ok) throw new Error('API save failed');
            const saved = await res.json();
            // Update local store with server-provided id if present
            const id = saved.id ?? saved._id ?? entry.id ?? String(Date.now() + Math.random());
            // Refresh entries from server to keep consistent
            await fetchEntries();
            showToast('Saved to server');
            return;
          } catch (err) {
            console.warn('Save to API failed, saving local', err);
            showToast('Could not save to server — saved locally');
            online = false;
          }
        }

        // Offline fallback: assign id if needed and save local
        const id = entry.id ?? String(Date.now() + Math.floor(Math.random() * 10000));
        const newEntry = { ...entry, id };
        if (idx === null) {
          entries.push(newEntry);
        } else {
          // find index by id
          const i = entries.findIndex(e => e.id === entry.id);
          if (i >= 0) entries[i] = newEntry;
          else entries.push(newEntry);
        }
        saveLocal(prefix, entries);
        render();
      }

      async function deleteEntry(id) {
        if (!confirm('Delete this entry?')) return;
        if (online) {
          try {
            const res = await fetch(`${apiBase}/${prefix}/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('API delete failed');
            await fetchEntries();
            showToast('Deleted on server');
            return;
          } catch (err) {
            console.warn('Delete on API failed, deleting locally', err);
            showToast('Could not delete on server — deleted locally');
            online = false;
          }
        }
        // Local delete fallback
        entries = entries.filter(e => e.id !== id);
        saveLocal(prefix, entries);
        render();
      }

      function updateChart() {
        const credit = entries.filter(e => e.type === "Credit").reduce((sum, e) => sum + Number(e.amt), 0);
        const debit = entries.filter(e => e.type === "Debit").reduce((sum, e) => sum + Number(e.amt), 0);
        const data = {
          labels: ["Credit", "Debit"],
          datasets: [{
            data: [credit, debit],
            backgroundColor: ["#43a047", "#e53935"]
          }]
        };
        if (chart) { chart.data = data; chart.update(); }
        else {
          chart = new Chart(chartCtx, {
            type: "pie",
            data: data,
            options: {
              plugins: { legend: { display: true, labels: { font: { size: 16 } } } },
              responsive: true,
              maintainAspectRatio: false
            }
          });
        }
      }

      function render() {
        list.innerHTML = '';
        let total = 0;
        entries.forEach((e, i) => {
          if (editingIndex === i) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><input type="text" id="${prefix}-edit-desc" value="${e.desc || ''}" style="width:90px;"></td>
              <td><input type="number" id="${prefix}-edit-amt" value="${e.amt || 0}" style="width:70px;"></td>
              <td>
                <select id="${prefix}-edit-type">
                  <option value="Credit" ${e.type === 'Credit' ? 'selected' : ''}>Credit</option>
                  <option value="Debit" ${e.type === 'Debit' ? 'selected' : ''}>Debit</option>
                </select>
              </td>
              <td><input type="date" id="${prefix}-edit-date" value="${e.date || ''}"></td>
              <td>
                <select id="${prefix}-edit-status">
                  <option value="Pending" ${e.status === 'Pending' ? 'selected' : ''}>Pending</option>
                  <option value="Completed" ${e.status === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
              </td>
              <td>
                <button class="save-btn" data-index="${i}">Save</button>
                <button class="cancel-btn">Cancel</button>
              </td>
            `;
            list.appendChild(tr);
          } else {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${e.desc || ''}</td>
              <td>₹${Number(e.amt || 0).toFixed(2)}</td>
              <td>${e.type || ''}</td>
              <td>${e.date || ''}</td>
              <td><span class="status-${(e.status || 'Pending').toLowerCase()}">${e.status || 'Pending'}</span></td>
              <td>
                <button class="edit-btn" data-index="${i}">Edit</button>
                <button class="delete-btn" data-index="${i}">Delete</button>
              </td>
            `;
            list.appendChild(tr);
          }
          total += (e.type === 'Credit' ? Number(e.amt || 0) : -Number(e.amt || 0));
        });
        totalBox.textContent = total.toFixed(2);
        const dashEl = document.getElementById(dashId);
        if (dashEl) dashEl.textContent = total.toFixed(2);
        updateTotalDashboard();
        updateChart();
      }

      list.addEventListener('click', async function (ev) {
        if (ev.target.classList.contains('edit-btn')) {
          editingIndex = +ev.target.getAttribute('data-index');
          render();
        }
        else if (ev.target.classList.contains('save-btn')) {
          const idx = +ev.target.getAttribute('data-index');
          const desc = document.getElementById(`${prefix}-edit-desc`).value.trim();
          const amt = parseFloat(document.getElementById(`${prefix}-edit-amt`).value || 0);
          const type = document.getElementById(`${prefix}-edit-type`).value;
          const date = document.getElementById(`${prefix}-edit-date`).value;
          const status = document.getElementById(`${prefix}-edit-status`).value;
          if (!desc || !type || !date || isNaN(amt) || amt < 0) return showToast('Fill all fields correctly!');
          const entry = { ...entries[idx], desc, amt, type, date, status };
          await saveEntry(entry, idx);
          editingIndex = null;
          render();
        }
        else if (ev.target.classList.contains('cancel-btn')) {
          editingIndex = null; render();
        }
        else if (ev.target.classList.contains('delete-btn')) {
          const idx = +ev.target.getAttribute('data-index');
          const id = entries[idx]?.id;
          if (id) await deleteEntry(id);
          editingIndex = null;
        }
      });

      form.onsubmit = async function (ev) {
        ev.preventDefault();
        const desc = form.querySelector(`#${prefix}-desc`).value.trim();
        const amt = parseFloat(form.querySelector(`#${prefix}-amt`).value || 0);
        const type = form.querySelector(`#${prefix}-type`).value;
        const date = form.querySelector(`#${prefix}-date`).value;
        const status = form.querySelector(`#${prefix}-status`).value;
        if (!desc || !type || !date || isNaN(amt) || amt < 0) return showToast('Fill all fields correctly!');
        const entry = { desc, amt, type, date, status };
        await saveEntry(entry, null);
        form.reset();
      };

      // Initial load
      fetchEntries();

      // Return an object if needed externally
      return {
        fetchEntries
      };
    }

    function updateTotalDashboard() {
      const s = Number(document.getElementById('dash-salary').textContent) || 0;
      const h = Number(document.getElementById('dash-house').textContent) || 0;
      const o = Number(document.getElementById('dash-office').textContent) || 0;
      document.getElementById('dash-total').textContent = (s + h + o).toFixed(2);
    }

    // Navigation/Menu Logic (keeps original behaviour)
    const menuLinks = document.querySelectorAll("aside nav ul li a");
    const dashboardSlide = document.getElementById("dashboard-slide");
    const trackerSections = {
      salary: document.getElementById("salary-section"),
      house: document.getElementById("house-section"),
      office: document.getElementById("office-section")
    };
    menuLinks.forEach(link => {
      link.addEventListener('click', function (ev) {
        menuLinks.forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        dashboardSlide.style.display = 'none';
        document.getElementById("global-dashboard").style.display = 'none';
        for (const sc in trackerSections) trackerSections[sc].classList.remove('active');
        if (this.getAttribute('href') === "#dashboard") {
          dashboardSlide.style.display = '';
          document.getElementById("global-dashboard").style.display = 'block';
        } else if (this.getAttribute('href') === "#salary") {
          trackerSections.salary.classList.add('active');
        } else if (this.getAttribute('href') === "#house") {
          trackerSections.house.classList.add('active');
        } else if (this.getAttribute('href') === "#office") {
          trackerSections.office.classList.add('active');
        }
        ev.preventDefault();
      });
    });

    // Initialize trackers after DOM ready
    document.addEventListener('DOMContentLoaded', async () => {
      const apiIsUp = await checkApiStatus(); // set visual status early
      // create trackers (they will themselves try API and fallback to local)
      createTracker('salary', 'dash-salary', 'salaryChart');
      createTracker('house', 'dash-house', 'houseChart');
      createTracker('office', 'dash-office', 'officeChart');

      document.getElementById("dashboard-slide").style.display = '';
      document.getElementById("global-dashboard").style.display = 'block';
      for (const sc in trackerSections) trackerSections[sc].classList.remove('active');
      updateTotalDashboard();

      if (!apiIsUp) showToast('API unreachable — working offline (localStorage)');
    });
  </script>
</body>
</html>
